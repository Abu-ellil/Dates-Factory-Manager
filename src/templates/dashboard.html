{% extends "base.html" %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Date Factory Manager{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>

    <!-- Customer Selection -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                <select id="customerSelect"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
                    <option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ --</option>
                </select>
            </div>
            <div>
                <label class="block text-lg font-semibold text-gray-700 dark:text-gray-200 mb-3">Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹:</label>
                <input type="text" id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..."
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white">
            </div>
        </div>
    </div>

    <!-- Metrics Grid -->
    <div id="metricsContainer" class="hidden">
        <!-- Financial Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ²Ù† Ø§Ù„ØµØ§ÙÙŠ</p>
                        <p class="text-3xl font-bold text-primary dark:text-blue-400" id="totalWeight">0</p>
                        <p class="text-gray-400 text-xs mt-1">ÙƒØ¬Ù…</p>
                    </div>
                    <div class="bg-primary/10 dark:bg-blue-900/30 p-3 rounded-full">
                        <svg class="w-8 h-8 text-primary dark:text-blue-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª</p>
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400" id="totalValue">0</p>
                        <p class="text-gray-400 text-xs mt-1">Ø¬Ù†ÙŠÙ‡</p>
                    </div>
                    <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded-full">
                        <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„</p>
                        <p class="text-3xl font-bold text-red-600 dark:text-red-400" id="totalPaid">0</p>
                        <p class="text-gray-400 text-xs mt-1">Ø¬Ù†ÙŠÙ‡</p>
                    </div>
                    <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded-full">
                        <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                        <p class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="totalReceived">0</p>
                        <p class="text-gray-400 text-xs mt-1">Ø¬Ù†ÙŠÙ‡</p>
                    </div>
                    <div class="bg-blue-100 dark:bg-blue-900/30 p-3 rounded-full">
                        <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div
                class="bg-gradient-to-br from-yellow-400 to-orange-500 dark:from-yellow-600 dark:to-orange-700 rounded-lg shadow-lg p-6 text-white card-hover">
                <h3 class="text-xl font-semibold mb-2">ğŸ’° ØµØ§ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
                <p class="text-4xl font-bold" id="balance">0</p>
                <p class="text-sm mt-2 opacity-90">Ø¬Ù†ÙŠÙ‡ (Ù„Ù‡/Ø¹Ù„ÙŠÙ‡)</p>
            </div>

            <div
                class="bg-gradient-to-br from-purple-500 to-indigo-600 dark:from-purple-700 dark:to-indigo-800 rounded-lg shadow-lg p-6 text-white card-hover">
                <h3 class="text-xl font-semibold mb-2">ğŸ“¦ Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</h3>
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div>
                        <p class="text-sm opacity-90">Ù…Ù†ØµØ±ÙØ©</p>
                        <p class="text-2xl font-bold" id="cratesOut">0</p>
                    </div>
                    <div>
                        <p class="text-sm opacity-90">Ù…Ø±ØªØ¯Ø©</p>
                        <p class="text-2xl font-bold" id="cratesReturned">0</p>
                    </div>
                    <div>
                        <p class="text-sm opacity-90">Ø§Ù„Ø¨Ø§Ù‚ÙŠ</p>
                        <p class="text-2xl font-bold" id="cratesBalance">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-12">
        <svg class="w-24 h-24 mx-auto text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
            </path>
        </svg>
        <p class="text-gray-500 dark:text-gray-400 text-lg">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allCustomers = [];

    // Load customers
    async function loadCustomers() {
        const response = await fetch('/api/customers');
        allCustomers = await response.json();

        updateCustomerDropdown(allCustomers);
    }

    // Update dropdown with filtered customers
    function updateCustomerDropdown(customers) {
        const select = document.getElementById('customerSelect');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ --</option>';

        customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = `${customer.name} (${customer.type})`;
            select.appendChild(option);
        });
    }

    // Search functionality
    document.getElementById('searchBox').addEventListener('input', function (e) {
        const searchTerm = e.target.value.toLowerCase();

        if (!searchTerm) {
            updateCustomerDropdown(allCustomers);
            return;
        }

        const filtered = allCustomers.filter(customer =>
            customer.name.toLowerCase().includes(searchTerm) ||
            customer.type.toLowerCase().includes(searchTerm) ||
            (customer.phone && customer.phone.includes(searchTerm))
        );

        updateCustomerDropdown(filtered);

        // Auto-select if only one result
        if (filtered.length === 1) {
            document.getElementById('customerSelect').value = filtered[0].id;
            loadDashboard(filtered[0].id);
        }
    });

    // Load dashboard metrics
    async function loadDashboard(customerId) {
        if (!customerId) {
            document.getElementById('metricsContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            return;
        }

        const response = await fetch(`/api/dashboard/${customerId}`);
        const data = await response.json();

        // Update metrics
        document.getElementById('totalWeight').textContent = data.total_weight.toLocaleString('ar-EG', { maximumFractionDigits: 2 });
        document.getElementById('totalValue').textContent = data.total_value.toLocaleString('ar-EG', { maximumFractionDigits: 2 });
        document.getElementById('totalPaid').textContent = data.total_paid.toLocaleString('ar-EG', { maximumFractionDigits: 2 });
        document.getElementById('totalReceived').textContent = data.total_received.toLocaleString('ar-EG', { maximumFractionDigits: 2 });
        document.getElementById('balance').textContent = data.balance.toLocaleString('ar-EG', { maximumFractionDigits: 2 });
        document.getElementById('cratesOut').textContent = data.crates_out;
        document.getElementById('cratesReturned').textContent = data.crates_returned;
        document.getElementById('cratesBalance').textContent = data.crates_balance;

        // Show metrics
        document.getElementById('metricsContainer').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');
    }

    // Event listeners
    document.getElementById('customerSelect').addEventListener('change', function () {
        loadDashboard(this.value);
    });

    // Initialize
    loadCustomers();
</script>
{% endblock %}