# استعادة البيانات - Data Restore Feature

## نظرة عامة
تتيح هذه الميزة للمستخدمين استعادة البيانات من ملفات Excel التي تم تصديرها من التطبيق أو من النسخ الاحتياطية.

## الوصول إلى الميزة
1. افتح التطبيق وسجل الدخول
2. انتقل إلى **الإعدادات** من القائمة الجانبية
3. اضغط على زر **استعادة البيانات** في قسم "استعادة البيانات"

## أوضاع الاستعادة

### 1. وضع الدمج (Merge Mode)
- **الوصف**: يضيف البيانات الجديدة من الملف دون حذف البيانات الموجودة
- **الاستخدام**: مناسب لإضافة بيانات جديدة أو دمج بيانات من مصادر متعددة
- **ملاحظة**: العملاء الموجودين بنفس الاسم لن يتم تكرارهم

### 2. وضع الاستبدال (Replace Mode)
- **الوصف**: يحذف جميع البيانات الحالية ويستبدلها بالبيانات من الملف
- **الاستخدام**: مناسب لاستعادة نسخة احتياطية كاملة أو إعادة تعيين البيانات
- **تحذير**: يتطلب تأكيد من المستخدم لأنه يحذف جميع البيانات الحالية

## البيانات المدعومة
يمكن استعادة الأنواع التالية من البيانات:
- ✅ **العملاء** (Customers)
- ✅ **معاملات الميزان** (Weighbridge Transactions)
- ✅ **معاملات الصناديق** (Crates Transactions)
- ✅ **المعاملات المالية** (Finance Transactions)

## متطلبات الملف
- **التنسيق**: Excel (.xlsx أو .xls)
- **المصدر**: ملفات تم تصديرها من هذا التطبيق أو نسخ احتياطية
- **الأوراق المطلوبة**:
  - `العملاء (Customers)`
  - `الميزان (Weighbridge)`
  - `الصناديق (Crates)`
  - `المالية (Finance)`

## خطوات الاستعادة

### الطريقة الأولى: من واجهة التطبيق
1. اذهب إلى **الإعدادات** → **استعادة البيانات**
2. اختر ملف Excel
3. حدد وضع الاستعادة (دمج أو استبدال)
4. إذا اخترت وضع الاستبدال، قم بتأكيد الحذف
5. اضغط على **استعادة البيانات**
6. انتظر حتى تكتمل العملية
7. راجع النتائج والأخطاء إن وجدت

### الطريقة الثانية: من سطر الأوامر
```bash
cd src
python restore_data.py "path/to/backup.xlsx" merge
```

أو للاستبدال:
```bash
python restore_data.py "path/to/backup.xlsx" replace
```

## نصائح مهمة

### قبل الاستعادة
- ✅ قم بعمل نسخة احتياطية من البيانات الحالية
- ✅ تأكد من أن الملف بالتنسيق الصحيح
- ✅ تحقق من أن أسماء العملاء مطابقة تماماً

### أثناء الاستعادة
- ⏳ لا تغلق التطبيق أثناء عملية الاستعادة
- ⏳ انتظر حتى تظهر رسالة النجاح

### بعد الاستعادة
- ✅ راجع البيانات المستعادة
- ✅ تحقق من الأخطاء إن وجدت
- ✅ قم بعمل نسخة احتياطية جديدة

## معالجة الأخطاء

### الأخطاء الشائعة وحلولها

#### "Customer not found"
- **السبب**: اسم العميل في الملف غير موجود في قاعدة البيانات
- **الحل**: تأكد من استعادة ورقة العملاء أولاً أو استخدم وضع الدمج

#### "File format not supported"
- **السبب**: الملف ليس بتنسيق Excel صحيح
- **الحل**: تأكد من أن الملف بامتداد .xlsx أو .xls

#### "Sheet not found"
- **السبب**: الملف لا يحتوي على الأوراق المطلوبة
- **الحل**: استخدم ملف تم تصديره من التطبيق

## الملفات المتعلقة
- `src/restore_data.py` - وحدة استعادة البيانات الرئيسية
- `src/templates/restore.html` - واجهة المستخدم
- `src/app.py` - مسارات API (routes)

## API Endpoint
```
POST /api/restore
Content-Type: multipart/form-data

Parameters:
- file: Excel file
- mode: "merge" or "replace"

Response:
{
  "success": true,
  "message": "تمت استعادة البيانات بنجاح",
  "stats": {
    "customers": {"added": 10, "skipped": 5, "errors": []},
    "weighbridge": {"added": 50, "errors": []},
    "crates": {"added": 30, "errors": []},
    "finance": {"added": 40, "errors": []}
  }
}
```

## الأمان
- ✅ يتطلب تسجيل الدخول (@login_required)
- ✅ يتحقق من نوع الملف
- ✅ يستخدم ملفات مؤقتة آمنة
- ✅ يحذف الملفات المؤقتة بعد الاستخدام

## الأداء
- معالجة البيانات تتم على دفعات
- استخدام معاملات قاعدة البيانات (transactions) لضمان سلامة البيانات
- عرض تقدم العملية للمستخدم

## الدعم
إذا واجهت أي مشاكل:
1. تحقق من سجلات الأخطاء
2. تأكد من صحة تنسيق الملف
3. جرب استخدام ملف تصدير جديد
4. اتصل بالدعم الفني
